
############
## Helper ##
############

# enumeration #

- $id: encoding
  enum:
    - buffer
    - utf8
    - utf16le
    - latin1

- $id: ordering
  enum:
    - chronological
    - causal

- $id: log-level
  enum:
    - debug
    - info
    - warning
    - error
    - off

- $id: file-type
  enum:
    - script
    - module

- $id: recorder
  enum:
    - process
    - mocha
    - manual
    - empty

- $id: mode
  enum:
    - local
    - remote

- $id: target
  enum:
    - file-system
    - http

- $id: serialization-method
  enum:
    - toString
    - Object.prototype.toString

- $id: stdio-stream
  enum:
    - ignore
    - pipe
    - inherit

- $id: signal
  enum:
    - SIGINT
    - SIGTERM
    - SIGKILL

- $id: indent
  enum:
    - 0
    - 2
    - 4
    - 8

# primitive #

- $id: exclusion
  type: string

- $id: regular-identifier
  type: string
  pattern: "^[a-zA-Z_$][a-zA-Z_$-9]*$"

- $id: path
  type: string

- $id: absolute-path
  type: string
  pattern: "^/"

- $id: basename
  type: string
  pattern: "^[^/.]+$"

- $id: extension
  type: string
  pattern: "^\\.[^/]+$"

- $id: index
  type: integer
  minimum: 0
  maximum: 9007199254740991

- $id: port-number
  type: integer
  minimum: 1
  maximum: 65535

- $id: port
  anyOf:
    - $ref: path
    - $ref: port-number

- $id: absolute-port
  anyOf:
    - $ref: absolute-path
    - $ref: port-number

# name-version #

- $id: name-version-string
  type: string
  pattern: "^[^@]+@[^@]+$"

- $id: name-version-object
  type: object
  additionalProperties: false
  required: [name, version]
  properties:
    name: {type: string}
    version: {type: string}

- $id: name-version
  anyOf:
    - $ref: name-version-string
    - $ref: name-version-object

# recording #

- $id: recording-string
  type: string
  pattern: "^[^.]+.[^.]+$"

- $id: recording-object
  type: object
  additionalProperties: false
  required: [defined-class, method-id]
  properties:
    defined-class: {type: string}
    method-id: {type: string}

- $id: recording
  anyOf:
    - $ref: recording-string
    - $ref: recording-object

# other #

- $id: package
  type: object
  additionalProperties: false
  required: [name, version, homepage]
  properties:
    name: {type: string}
    version: {type: string}
    homepage:
      type: string
      nullable: true

- $id: exclude
  type: array
  items: {$ref: exclusion}

- $id: stdio
  anyOf:
    - $ref: stdio-stream
    - type: array
      minItems: 3
      maxItems: 3
      items:
        - {$ref: stdio-stream}
        - {$ref: stdio-stream}
        - {$ref: stdio-stream}

- $id: env
  type: object
  additionalProperties: false
  patternProperties:
    "^": {type: string}

###############
## Specifier ##
###############

- $id: specifier
  anyOf:
    - type: object
      additionalProperties: false
      required: [regexp]
      properties:
        regexp:
          type: string
        flags:
          type: string
        enabled: {type: boolean}
        shallow: {type: boolean}
        exclude: {$ref: exclude}
        source:
          type: boolean
          nullable: true
    - type: object
      additionalProperties: false
      required: [glob]
      properties:
        glob: {type: string}
        enabled: {type: boolean}
        shallow: {type: boolean}
        exclude: {$ref: exclude}
        source:
          type: boolean
          nullable: true
    - type: object
      additionalProperties: false
      required: [path]
      properties:
        path: {type: string}
        recursive: {type: boolean}
        enabled: {type: boolean}
        shallow: {type: boolean}
        exclude: {$ref: exclude}
        source:
          type: boolean
          nullable: true
    - type: object
      additionalProperties: false
      required: [dist]
      properties:
        dist: {type: string}
        recursive: {type: boolean}
        external: {type: boolean}
        enabled: {type: boolean}
        shallow: {type: boolean}
        exclude: {$ref: exclude}
        source:
          type: boolean
          nullable: true

- $id: package-specifier
  anyOf:
    - type: string
    - $ref: specifier

- $id: enabled-specifier
  anyOf:
    - type: boolean
    - type: string
    - allOf:
      - $ref: specifier
      - not:
          anyOf:
            - type: object
              required: [shallow]
            - type: object
              required: [source]
            - type: object
              required: [exclude]

- $id: cooked-specifier
  type: object
  additionalProperties: false
  required: [basedir, source, flags]
  properties:
    basedir: {$ref: absolute-path}
    source: {type: string}
    flags: {type: string}

##############
## Children ##
##############

- $id: child-options
  type: object
  additionalProperties: false
  properties:
    execPath: {type: string}
    execArgv: {type: string}
    encoding: {$ref: encoding}
    cwd: {$ref: path}
    env: {$ref: env}
    stdio: {$ref: stdio}
    timeout:
      type: integer
      minimum: 0
    killSignal: {$ref: signal}

- $id: child
  anyOf:
    - type: string
    - type: array
      minItems: 1
      items: {type: string}
    - type: object
      additionalProperties: false
      required: [type, exec]
      properties:
        type: {const: spawn}
        configuration: {$ref: configuration}
        exec: {type: string}
        argv:
          type: array
          items: {type: string}
        options:
          allOf:
            - $ref: child-options
            - not:
                anyOf:
                  - type: object
                    required: [execPath]
                  - type: object
                    required: [execArgv]
    - type: object
      additionalProperties: false
      required: [type, exec]
      properties:
        type: {const: fork}
        configuration: {$ref: configuration}
        globbing: {type: boolean}
        exec: {type: string}
        argv:
          type: array
          items: {type: string}
        options: {$ref: child-options}

- $id: cooked-child
  type: object
  additionalProperties: false
  required: [fork, exec, argv, configuration, options]
  properties:
    fork:
      type: object
      nullable: true
      required: [directory, data]
      additionalProperties: false
      properties:
        directory: {$ref: absolute-path}
        data: {$ref: configuration}
    exec: {type: string}
    argv:
      type: array
      items: {type: string}
    configuration:
      type: object
      additionalProperties: false
      required: [directory, data]
      properties:
        directory: {$ref: absolute-path}
        data: {$ref: configuration}
    options:
      allOf:
        - $ref: child-options
        - type: object
          required: [encoding, cwd, env, stdio, timeout, killSignal]
          maxProperties: 6
          properties:
            cwd: {$ref: absolute-path}

#################
# Configuration #
#################

- $id: configuration
  type: object
  additionalProperties: false
  properties:
    # server
    mode: {$ref: mode}
    validate:
      type: object
      additionalProperties: false
      properties:
        message: {type: boolean}
        appmap: {type: boolean}

    log: {$ref: log-level}
    host: {const: localhost}
    trace-port:
      anyOf:
        - const: 0
        - $ref: port
    trace-protocol: {const: TCP}
    track-port:
      anyOf:
        - const: 0
        - $ref: port
    track-protocol: {const: "HTTP/1.1"}
    local-track-port:
      anyOf:
        - const: null
        - $ref: port
    local-track-protocol: {const: "HTTP/1.1"}
    intercept-track-port:
      anyOf:
        - const: null
        - $ref: port
    intercept-track-protocol: {const: "HTTP/1.1"}
    scenario: {type: string}
    scenarios:
      type: object
      additionalProperties: false
      patternProperties:
        "^":
          anyOf:
            - type: array
              items: {$ref: child}
            - $ref: child
    # client
    recorder: {$ref: recorder}
    source: {type: boolean}
    hooks:
      type: object
      additionalProperties: false
      properties:
        cjs: {type: boolean}
        esm: {type: boolean}
        apply: {type: boolean}
        http: {type: boolean}
        mysql: {type: boolean}
        pg: {type: boolean}
        sqlite3: {type: boolean}
    ordering: {$ref: ordering}
    enabled:
      anyOf:
        - const: process
        - type: boolean
    processes:
      anyOf:
        - $ref: enabled-specifier
        - type: array
          items: {$ref: enabled-specifier}
    hidden-identifier: {$ref: regular-identifier}
    main: {$ref: path}
    engine: {$ref: name-version}
    language: {$ref: name-version}
    packages:
      anyOf:
        - $ref: package-specifier
        - type: array
          items: {$ref: package-specifier}
    exclude: {$ref: exclude}
    # recording
    function-name-placeholder: {type: string}
    recording: {$ref: recording}
    serialization:
      anyOf:
        - type: string
        - type: object
          additionalProperties: false
          properties:
            method: {$ref: serialization-method}
            include-constructor-name: {type: boolean}
            maximum-length:
              type: integer
              minimum: 0
              nullable: true
    pruning: {type: boolean}
    output:
      anyOf:
        - const: null
        - type: string
        - type: object
          additionalProperties: false
          properties:
            target: {$ref: target}
            directory: {$ref: path}
            basename: {$ref: basename}
            extension: {$ref: extension}
    app: {type: string}
    name: {type: string}
    feature: {type: string}
    feature-group: {type: string}
    labels:
      type: array
      items: {type: string}
    frameworks:
      type: array
      items: {$ref: name-version}

- $id: cooked-configuration
  type: object
  additionalProperties: false
  minProperties: 35
  properties:
    mode: {$ref: mode}
    validate:
      type: object
      additionalProperties: false
      required: [message, appmap]
      properties:
        message: {type: boolean}
        appmap: {type: boolean}
    repository:
      type: object
      additionalProperties: false
      required: [directory, history, package]
      properties:
        directory: {$ref: absolute-path}
        history:
          type: object
          nullable: true
        package:
          anyOf:
            - const: null
            - $ref: package
    agent:
      type: object
      additionalProperties: false
      required: [directory, package]
      properties:
        directory: {$ref: absolute-path}
        package: {$ref: package}
    scenario: {type: string}
    scenarios:
      type: object
      additionalProperties: false
      patternProperties:
        "^":
          type: array
          items: {$ref: cooked-child}
    log: {$ref: log-level}
    host: {const: localhost}
    trace-port:
      anyOf:
        - const: 0
        - $ref: absolute-port
    trace-protocol: {const: TCP}
    track-port:
      anyOf:
        - const: 0
        - $ref: absolute-port
    track-protocol: {const: "HTTP/1.1"}
    local-track-port:
      anyOf:
        - const: null
        - $ref: absolute-port
    local-track-protocol: {const: "HTTP/1.1"}
    intercept-track-port:
      anyOf:
        - const: null
        - $ref: absolute-port
    intercept-track-protocol: {const: "HTTP/1.1"}
    recorder: {$ref: recorder}
    source: {type: boolean}
    hooks:
      type: object
      additionalProperties: false
      required: [cjs, esm, apply, http, mysql, pg, sqlite3]
      properties:
        cjs: {type: boolean}
        esm: {type: boolean}
        apply: {type: boolean}
        http: {type: boolean}
        mysql: {type: boolean}
        pg: {type: boolean}
        sqlite3: {type: boolean}
    ordering: {$ref: ordering}
    enabled:
      anyOf:
        - const: process
        - type: boolean
    processes:
      type: array
      items:
        type: array
        minItems: 2
        maxItems: 2
        items:
          - $ref: cooked-specifier
          - type: boolean
    hidden-identifier: {$ref: regular-identifier}
    main:
      anyOf:
        - const: null
        - $ref: absolute-path
    engine:
      anyOf:
        - const: null
        - $ref: name-version-object
    language:
      $ref: name-version-object
    packages:
      type: array
      items:
        type: array
        minItems: 2
        maxItems: 2
        items:
          - $ref: cooked-specifier
          - type: object
            properties:
              enabled: {type: boolean}
              shallow: {type: boolean}
              source:
                type: boolean
                nullable: true
              exclude: {$ref: exclude}
    exclude: {$ref: exclude}
    # recording
    function-name-placeholder: {type: string}
    recording:
      anyOf:
        - const: null
        - $ref: recording-object
    serialization:
      type: object
      additionalProperties: false
      required: [maximum-length, include-constructor-name, method]
      properties:
        maximum-length:
          type: integer
          minimum: 0
          nullable: true
        include-constructor-name: {type: boolean}
        method: {$ref: serialization-method}
    pruning: {type: boolean}
    output:
      type: object
      additionalProperties: false
      required: [target, directory, basename, extension]
      properties:
        target: {$ref: target}
        directory: {$ref: absolute-path}
        basename:
          anyOf:
            - const: null
            - $ref: basename
        extension: {$ref: extension}
    app:
      type: string
      nullable: true
    name:
      type: string
      nullable: true
    feature:
      type: string
      nullable: true
    feature-group:
      type: string
      nullable: true
    labels:
      type: array
      items: {type: string}
    frameworks:
      type: array
      items: {$ref: name-version}

###########
# message #
###########

- $id: initialization
  type: object
  additionalProperties: false
  required: [path, data]
  properties:
    path:
      anyOf:
        - const: null
        - $ref: absolute-path
    data: {$ref: configuration}

- $id: termination
  type: object
  additionalProperties: false
  required: [status, errors]
  properties:
    status:
      type: integer
      minimum: 0
      maximum: 255
    errors:
      type: array
      items:
        type: object
        additionalProperties: false
        required: [name, message, stack]
        properties:
          name: {type: string}
          message: {type: string}
          stack: {type: string}

- $id: file
  type: object
  additionalProperties: false
  required: [index, shallow, source, exclude, type, path, code]
  properties:
    index: {$ref: index}
    shallow: {type: boolean}
    source: {type: boolean}
    exclude:
      type: array
      items: {type: string}
    type: {$ref: file-type}
    path: {$ref: absolute-path}
    code: {type: string}

- $id: message
  anyOf:
    - type: array
      minItems: 2
      maxItems: 2
      items:
        - const: initialize
        - $ref: cooked-configuration
    - type: array
      minItems: 2
      maxItems: 2
      items:
        - const: terminate
        - $ref: termination
    - type: array
      minItems: 3
      maxItems: 3
      items:
        - const: start
        - type: string
        - $ref: initialization
    - type: array
      minItems: 3
      maxItems: 3
      items:
        - const: stop
        - type: string
        - $ref: termination
    - type: array
      minItems: 2
      maxItems: 2
      items:
        - const: file
        - $ref: file
    - type: array
      minItems: 6
      maxItems: 6
      items:
        - const: event
        - enum:
          - begin
          - end
          - before
          - after
        - $ref: index
        - type: number
        - enum:
          - bundle
          - apply
          - response
          - jump
          - request
          - query
        - true
